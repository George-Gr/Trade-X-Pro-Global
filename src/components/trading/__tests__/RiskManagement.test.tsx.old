import { describe, it, expect, vi } from 'vitest';
import { render, screen, waitFor, within } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import {
  RiskMetrics,
  RiskGauge,
  RiskLevelIndicator,
  MarginMonitor,
  type RiskMetricsData,
  type RiskLevel,
} from '../RiskManagement';

// ============================================================================
// RiskMetrics Tests
// ============================================================================

describe('RiskMetrics', () => {
  const mockRiskMetrics: RiskMetricsData = {
    maxDrawdown: 5.5,
    VAR_95: 2500,
    sharpeRatio: 1.8,
    winRate: 65,
    profitFactor: 2.1,
    riskRewardRatio: 1.5,
    avgWinLoss: 1.8,
    maxConsecutiveLosses: 3,
    riskPerTrade: 2,
    portfolioRisk: 8.5,
  };

  it('should render all risk metrics', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText(/Max Drawdown/)).toBeInTheDocument();
    expect(screen.getByText(/Sharpe Ratio/)).toBeInTheDocument();
    expect(screen.getByText(/Win Rate/)).toBeInTheDocument();
  });

  it('should display maximum drawdown value', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText('5.50%')).toBeInTheDocument();
  });

  it('should display Value at Risk (VaR)', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText(/\$2,500.00/)).toBeInTheDocument();
  });

  it('should show Sharpe Ratio', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText('1.80')).toBeInTheDocument();
  });

  it('should display win rate percentage', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText('65%')).toBeInTheDocument();
  });

  it('should show profit factor', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText('2.10')).toBeInTheDocument();
  });

  it('should display risk/reward ratio', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText('1.5:1')).toBeInTheDocument();
  });

  it('should show average win/loss ratio', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText('1.80')).toBeInTheDocument();
  });

  it('should display max consecutive losses', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText('3')).toBeInTheDocument();
  });

  it('should show risk per trade percentage', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText('2.00%')).toBeInTheDocument();
  });

  it('should display overall portfolio risk level', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    expect(screen.getByText(/Portfolio Risk/)).toBeInTheDocument();
    expect(screen.getByText('8.50%')).toBeInTheDocument();
  });

  it('should color drawdown based on severity', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    const drawdownElement = screen.getByText('5.50%');
    expect(drawdownElement).toHaveClass('text-yellow-600');
  });

  it('should show warning color for high drawdown', () => {
    const highDrawdownMetrics: RiskMetricsData = {
      ...mockRiskMetrics,
      maxDrawdown: 15,
    };
    render(<RiskMetrics metrics={highDrawdownMetrics} />);
    const drawdownElement = screen.getByText('15.00%');
    expect(drawdownElement).toHaveClass('text-red-600');
  });

  it('should show good color for low drawdown', () => {
    const lowDrawdownMetrics: RiskMetricsData = {
      ...mockRiskMetrics,
      maxDrawdown: 2,
    };
    render(<RiskMetrics metrics={lowDrawdownMetrics} />);
    const drawdownElement = screen.getByText('2.00%');
    expect(drawdownElement).toHaveClass('text-green-600');
  });

  it('should include tooltips for each metric', () => {
    render(<RiskMetrics metrics={mockRiskMetrics} />);
    const elements = screen.getAllByText(/Max Drawdown/);
    expect(elements[0].parentElement).toHaveAttribute('title');
  });

  it('should display metrics in a grid layout', () => {
    const { container } = render(<RiskMetrics metrics={mockRiskMetrics} />);
    const grid = container.querySelector('[class*="grid"]');
    expect(grid).toBeInTheDocument();
  });

  it('should handle missing metrics gracefully', () => {
    const partialMetrics: RiskMetricsData = {
      ...mockRiskMetrics,
      sharpeRatio: undefined as any,
    };
    render(<RiskMetrics metrics={partialMetrics} />);
    expect(screen.getByText(/N\/A/)).toBeInTheDocument();
  });
});

// ============================================================================
// RiskGauge Tests
// ============================================================================

describe('RiskGauge', () => {
  it('should render gauge component', () => {
    render(<RiskGauge currentRisk={45} maxRisk={100} />);
    expect(screen.getByRole('progressbar')).toBeInTheDocument();
  });

  it('should display risk percentage', () => {
    render(<RiskGauge currentRisk={45} maxRisk={100} />);
    expect(screen.getByText('45%')).toBeInTheDocument();
  });

  it('should show green color for low risk', () => {
    render(<RiskGauge currentRisk={25} maxRisk={100} />);
    const gauge = screen.getByRole('progressbar');
    expect(gauge).toHaveClass('bg-green-500');
  });

  it('should show yellow color for medium risk', () => {
    render(<RiskGauge currentRisk={50} maxRisk={100} />);
    const gauge = screen.getByRole('progressbar');
    expect(gauge).toHaveClass('bg-yellow-500');
  });

  it('should show orange color for high risk', () => {
    render(<RiskGauge currentRisk={75} maxRisk={100} />);
    const gauge = screen.getByRole('progressbar');
    expect(gauge).toHaveClass('bg-orange-500');
  });

  it('should show red color for critical risk', () => {
    render(<RiskGauge currentRisk={95} maxRisk={100} />);
    const gauge = screen.getByRole('progressbar');
    expect(gauge).toHaveClass('bg-red-500');
  });

  it('should display threshold lines', () => {
    const { container } = render(
      <RiskGauge currentRisk={45} maxRisk={100} showThresholds={true} />
    );
    const thresholds = container.querySelectorAll('[class*="threshold"]');
    expect(thresholds.length).toBeGreaterThan(0);
  });

  it('should animate progress changes', () => {
    const { rerender } = render(
      <RiskGauge currentRisk={25} maxRisk={100} />
    );
    rerender(<RiskGauge currentRisk={75} maxRisk={100} />);
    const gauge = screen.getByRole('progressbar');
    expect(gauge).toHaveClass('transition');
  });

  it('should show warning text when approaching limit', () => {
    render(<RiskGauge currentRisk={85} maxRisk={100} />);
    expect(screen.getByText(/Approaching limit/)).toBeInTheDocument();
  });

  it('should show critical text when exceeding limit', () => {
    render(<RiskGauge currentRisk={100} maxRisk={100} />);
    expect(screen.getByText(/Risk limit reached/)).toBeInTheDocument();
  });

  it('should display custom label if provided', () => {
    render(
      <RiskGauge 
        currentRisk={45} 
        maxRisk={100} 
        label="Account Risk"
      />
    );
    expect(screen.getByText('Account Risk')).toBeInTheDocument();
  });
});

// ============================================================================
// RiskLevelIndicator Tests
// ============================================================================

describe('RiskLevelIndicator', () => {
  const riskLevels: RiskLevel[] = ['low', 'medium', 'high', 'critical'];

  riskLevels.forEach((level) => {
    it(`should render ${level} risk indicator`, () => {
      render(<RiskLevelIndicator level={level} />);
      expect(screen.getByText(level.charAt(0).toUpperCase() + level.slice(1))).toBeInTheDocument();
    });
  });

  it('should color low risk in green', () => {
    render(<RiskLevelIndicator level="low" />);
    const indicator = screen.getByText('Low');
    expect(indicator).toHaveClass('text-green-600');
  });

  it('should color medium risk in yellow', () => {
    render(<RiskLevelIndicator level="medium" />);
    const indicator = screen.getByText('Medium');
    expect(indicator).toHaveClass('text-yellow-600');
  });

  it('should color high risk in orange', () => {
    render(<RiskLevelIndicator level="high" />);
    const indicator = screen.getByText('High');
    expect(indicator).toHaveClass('text-orange-600');
  });

  it('should color critical risk in red', () => {
    render(<RiskLevelIndicator level="critical" />);
    const indicator = screen.getByText('Critical');
    expect(indicator).toHaveClass('text-red-600');
  });

  it('should display icon for each risk level', () => {
    const { container } = render(<RiskLevelIndicator level="high" />);
    const icon = container.querySelector('[class*="icon"]');
    expect(icon).toBeInTheDocument();
  });

  it('should display description when provided', () => {
    render(
      <RiskLevelIndicator 
        level="high" 
        description="Your portfolio exceeds recommended risk levels"
      />
    );
    expect(screen.getByText(/exceeds recommended risk/)).toBeInTheDocument();
  });

  it('should show action button for critical risk', () => {
    render(<RiskLevelIndicator level="critical" />);
    expect(screen.getByRole('button')).toBeInTheDocument();
  });

  it('should call onClick when clicked', async () => {
    const user = userEvent.setup();
    const mockOnClick = vi.fn();
    render(<RiskLevelIndicator level="critical" onClick={mockOnClick} />);
    
    const element = screen.getByText('Critical');
    await user.click(element);
    expect(mockOnClick).toHaveBeenCalled();
  });
});

// ============================================================================
// MarginMonitor Tests
// ============================================================================

describe('MarginMonitor', () => {
  const mockMarginData = {
    totalBalance: 100000,
    usedMargin: 60000,
    availableMargin: 40000,
    marginLevel: 166.67,
    marginCallLevel: 50,
    stopOutLevel: 20,
  };

  it('should render margin monitor component', () => {
    render(<MarginMonitor {...mockMarginData} />);
    expect(screen.getByText(/Margin Status/)).toBeInTheDocument();
  });

  it('should display total balance', () => {
    render(<MarginMonitor {...mockMarginData} />);
    expect(screen.getByText(/\$100,000.00/)).toBeInTheDocument();
  });

  it('should display used margin', () => {
    render(<MarginMonitor {...mockMarginData} />);
    expect(screen.getByText(/\$60,000.00/)).toBeInTheDocument();
  });

  it('should display available margin', () => {
    render(<MarginMonitor {...mockMarginData} />);
    expect(screen.getByText(/\$40,000.00/)).toBeInTheDocument();
  });

  it('should display margin level', () => {
    render(<MarginMonitor {...mockMarginData} />);
    expect(screen.getByText('166.67%')).toBeInTheDocument();
  });

  it('should show healthy margin level in green', () => {
    render(<MarginMonitor {...mockMarginData} />);
    const marginLevel = screen.getByText('166.67%');
    expect(marginLevel).toHaveClass('text-green-600');
  });

  it('should show warning margin level in yellow', () => {
    const warningMargin = {
      ...mockMarginData,
      marginLevel: 100,
      usedMargin: 90000,
      availableMargin: 10000,
    };
    render(<MarginMonitor {...warningMargin} />);
    const marginLevel = screen.getByText('100.00%');
    expect(marginLevel).toHaveClass('text-yellow-600');
  });

  it('should show critical margin level in red', () => {
    const criticalMargin = {
      ...mockMarginData,
      marginLevel: 50,
      usedMargin: 95000,
      availableMargin: 5000,
    };
    render(<MarginMonitor {...criticalMargin} />);
    const marginLevel = screen.getByText('50.00%');
    expect(marginLevel).toHaveClass('text-red-600');
  });

  it('should display margin utilization chart', () => {
    const { container } = render(<MarginMonitor {...mockMarginData} />);
    const chart = container.querySelector('[data-testid="margin-chart"]');
    expect(chart).toBeInTheDocument();
  });

  it('should show margin call warning', () => {
    const warningMargin = {
      ...mockMarginData,
      marginLevel: 45,
      usedMargin: 97000,
      availableMargin: 3000,
    };
    render(<MarginMonitor {...warningMargin} />);
    expect(screen.getByText(/Margin call/)).toBeInTheDocument();
  });

  it('should show stop out warning', () => {
    const stopOutMargin = {
      ...mockMarginData,
      marginLevel: 15,
      usedMargin: 99000,
      availableMargin: 1000,
    };
    render(<MarginMonitor {...stopOutMargin} />);
    expect(screen.getByText(/Stop out/)).toBeInTheDocument();
  });

  it('should provide margin top-up button', () => {
    render(<MarginMonitor {...mockMarginData} />);
    expect(screen.getByRole('button', { name: /Add Margin/i })).toBeInTheDocument();
  });

  it('should call onAddMargin when button clicked', async () => {
    const user = userEvent.setup();
    const mockOnAddMargin = vi.fn();
    render(<MarginMonitor {...mockMarginData} onAddMargin={mockOnAddMargin} />);

    const addButton = screen.getByRole('button', { name: /Add Margin/i });
    await user.click(addButton);
    expect(mockOnAddMargin).toHaveBeenCalled();
  });

  it('should display margin levels as percentages', () => {
    render(<MarginMonitor {...mockMarginData} />);
    expect(screen.getByText(/Margin Call Level: 50%/)).toBeInTheDocument();
    expect(screen.getByText(/Stop Out Level: 20%/)).toBeInTheDocument();
  });

  it('should update in real-time', () => {
    const { rerender } = render(<MarginMonitor {...mockMarginData} />);

    const updatedData = {
      ...mockMarginData,
      usedMargin: 70000,
      availableMargin: 30000,
      marginLevel: 142.86,
    };

    rerender(<MarginMonitor {...updatedData} />);
    expect(screen.getByText('142.86%')).toBeInTheDocument();
  });

  it('should show responsive layout', () => {
    const { container } = render(<MarginMonitor {...mockMarginData} />);
    const layout = container.querySelector('[class*="flex-col lg:flex-row"]');
    expect(layout).toBeInTheDocument();
  });

  it('should display margin breakdown table', () => {
    const { container } = render(<MarginMonitor {...mockMarginData} />);
    const table = container.querySelector('table');
    expect(table).toBeInTheDocument();
  });

  it('should show margin efficiency metric', () => {
    render(<MarginMonitor {...mockMarginData} />);
    expect(screen.getByText(/Margin Efficiency/)).toBeInTheDocument();
  });

  it('should calculate and display margin ratio', () => {
    render(<MarginMonitor {...mockMarginData} />);
    // Margin ratio = Used / Total
    expect(screen.getByText(/60%/)).toBeInTheDocument();
  });
});
