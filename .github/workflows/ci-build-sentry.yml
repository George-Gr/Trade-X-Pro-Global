name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Lint and test job
  lint-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Run E2E tests
        run: |
          npm run build
          npx playwright install
          npm run test:e2e

  # Build job
  build:
    runs-on: ubuntu-latest
    needs: lint-test
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        env:
          VITE_APP_VERSION: ${{ github.sha }}
        run: npm run build

      - name: Get release version
        id: get_version
        run: |
          VERSION=$(node -e "try{const p=require('./package.json'); console.log(p.version || process.env.GITHUB_SHA);}catch(e){console.log(process.env.GITHUB_SHA);}")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Release version: $VERSION"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist

      - name: Notify Sentry configuration
        if: ${{ env.VITE_SENTRY_DSN != '' }}
        run: echo "âœ“ Sentry DSN configured - error tracking enabled"

      - name: Install Sentry CLI
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != '' }}
        run: |
          echo "ðŸ“¥ Installing Sentry CLI..."
          curl -sL https://sentry.io/get-cli/ | bash
          sentry-cli --version

      - name: Create Sentry release
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != '' }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "ðŸš€ Creating Sentry release: $VERSION"

          # Create new release
          sentry-cli releases new "$VERSION"

          # Associate commits (ignore missing to prevent errors)
          sentry-cli releases set-commits "$VERSION" --auto --ignore-missing || echo "âš ï¸  Could not associate commits, continuing..."

          # Finalize release
          sentry-cli releases finalize "$VERSION"

          echo "âœ“ Sentry release created successfully"

      - name: Upload source maps to Sentry
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != '' }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "ðŸ“¤ Uploading source maps to Sentry..."

          sentry-cli releases files "$VERSION" upload-sourcemaps ./dist --url-prefix "~/" --rewrite

          echo "âœ“ Source maps uploaded successfully"

      - name: Deploy Sentry release
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != '' }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "ðŸŒ Deploying Sentry release to production..."

          sentry-cli releases deploys "$VERSION" new -e production

          echo "âœ“ Sentry release deployed to production"

  # Supabase deployment job (only on main branch push)
  supabase-deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        run: |
          curl -fsSL https://cli.supabase.com/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify Supabase CLI
        run: supabase --version

      - name: Link to Supabase project
        run: supabase link ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Push migrations and functions
        run: supabase push

      - name: Verify deployment
        run: |
          echo "âœ… Supabase deployment completed"
          echo "Project Ref: ${{ secrets.SUPABASE_PROJECT_REF }}"

      - name: Workflow complete
        run: |
          echo "================================================"
          echo "âœ“ CI/CD Pipeline completed successfully"
          echo "================================================"
