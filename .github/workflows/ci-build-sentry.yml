name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Security scanning job - runs in parallel with lint-test
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=package.json

      - name: Run Snyk to check for license issues
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --license-check --file=package.json

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Check for secrets with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # Functions lint and test job - validates server-side financial code
  functions-lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Deno lint + fmt + test
        run: |
          deno lint supabase/functions --unstable || true
          deno fmt --check supabase/functions || true
          deno test supabase/functions --unstable --allow-env

      - name: Type-check functions (tsc if applicable)
        run: tsc -p supabase/functions/tsconfig.json --noEmit

  # Lint and test job
  lint-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Run E2E tests
        run: |
          npm run build
          npx playwright install
          npm run test:e2e

      - name: Security scan before build
        run: |
          echo "üîç Running pre-build security checks..."
          npm audit --audit-level=high
          echo "‚úÖ Pre-build security checks passed"

  # Build job
  build:
    runs-on: ubuntu-latest
    needs: [lint-test, security-scan]
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        env:
          VITE_APP_VERSION: ${{ github.sha }}
        run: npm run build

      - name: Analyze bundle size
        run: |
          echo "üìä Analyzing bundle size..."
          npm run build:analyze
          echo "‚úÖ Bundle analysis completed"

      - name: Check bundle size limits
        run: |
          echo "üìè Checking bundle size limits..."
          
          # Check main bundle size (should be under 2MB uncompressed)
          MAIN_BUNDLE=$(find dist/assets -name "index-*.js" -print -quit)
          MAIN_BUNDLE_SIZE=$(wc -c < "$MAIN_BUNDLE")
          MAIN_GZIP_SIZE=$(gzip -c "$MAIN_BUNDLE" | wc -c)
          echo "Main bundle size: $((MAIN_BUNDLE_SIZE / 1024))KB (gzipped: $((MAIN_GZIP_SIZE / 1024))KB)"
          
          if [ $MAIN_GZIP_SIZE -gt 2097152 ]; then
            echo "‚ùå Main bundle gzipped size exceeds 2MB limit"
            exit 1
          fi
          
          # Check total bundle size (should be under 5MB gzipped)
          TOTAL_SIZE=$(du -sb dist | awk '{print $1}')
          echo "Total bundle size: $((TOTAL_SIZE / 1024))KB"
          
          if [ $TOTAL_SIZE -gt 5242880 ]; then
            echo "‚ùå Total bundle size exceeds 5MB limit"
            exit 1
          fi
          
          echo "‚úÖ Bundle size limits passed"
          
          echo "‚úÖ Bundle size limits passed"

      - name: Get release version
        id: get_version
        run: |
          VERSION=$(node -e "try{const p=require('./package.json'); console.log(p.version || process.env.GITHUB_SHA);}catch(e){console.log(process.env.GITHUB_SHA);}")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release version: $VERSION"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist

      - name: Notify Sentry configuration
        if: ${{ env.VITE_SENTRY_DSN != '' }}
        run: echo "‚úì Sentry DSN configured - error tracking enabled"

      - name: Install Sentry CLI
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != '' }}
        run: |
          echo "üì• Installing Sentry CLI..."
          curl -sL https://sentry.io/get-cli/ | bash
          sentry-cli --version

      - name: Create Sentry release
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != '' }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "üöÄ Creating Sentry release: $VERSION"

          # Create new release
          sentry-cli releases new "$VERSION"

          # Associate commits (ignore missing to prevent errors)
          sentry-cli releases set-commits "$VERSION" --auto --ignore-missing || echo "‚ö†Ô∏è  Could not associate commits, continuing..."

          # Finalize release
          sentry-cli releases finalize "$VERSION"

          echo "‚úì Sentry release created successfully"

      - name: Upload source maps to Sentry
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != '' }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "üì§ Uploading source maps to Sentry..."

          sentry-cli releases files "$VERSION" upload-sourcemaps ./dist --url-prefix "~/" --rewrite

          echo "‚úì Source maps uploaded successfully"

      - name: Deploy Sentry release
        if: ${{ env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != '' }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "üåê Deploying Sentry release to production..."

          sentry-cli releases deploys "$VERSION" new -e production

          echo "‚úì Sentry release deployed to production"

  # Supabase deployment job (only on main branch push)
  supabase-deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        run: |
          curl -fsSL https://cli.supabase.com/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify Supabase CLI
        run: supabase --version

      - name: Link to Supabase project
        run: supabase link ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Push migrations and functions
        run: supabase push

      - name: Verify deployment
        run: |
          echo "‚úÖ Supabase deployment completed"
          echo "Project Ref: ${{ secrets.SUPABASE_PROJECT_REF }}"

      - name: Workflow complete
        run: |
          echo "================================================"
          echo "‚úì CI/CD Pipeline completed successfully"
          echo "================================================"
