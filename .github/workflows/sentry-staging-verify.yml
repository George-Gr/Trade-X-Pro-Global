name: Sentry Staging Verification

on:
  push:
    branches: [ staging ]
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      VITE_APP_VERSION: ${{ github.sha }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize verification
        run: |
          echo "================================================"
          echo "Sentry Staging Verification Starting"
          echo "================================================"
          echo "Commit: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "================================================"

      - name: Install Sentry CLI
        if: env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != ''
        run: |
          echo "Installing Sentry CLI..."
          curl -sL https://sentry.io/get-cli/ | bash
          sentry-cli --version

      - name: Send test event to Sentry
        if: env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != ''
        run: |
          echo "Sending test event to Sentry..."
          sentry-cli send-event -m "Staging smoke test: commit=${{ github.sha }} run=${{ github.run_id }}"
          echo "Test event sent successfully"
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

      - name: Verify event ingestion
        if: env.SENTRY_AUTH_TOKEN != '' && env.SENTRY_ORG != '' && env.SENTRY_PROJECT != ''
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          
          echo "================================================"
          echo "Verifying Sentry Event Ingestion"
          echo "================================================"
          
          QUERY="Staging smoke test: commit=${GITHUB_SHA} run=${GITHUB_RUN_ID}"
          ENCODED_QUERY=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))" "$QUERY")
          AUTH="Authorization: Bearer ${SENTRY_AUTH_TOKEN}"
          URL="https://sentry.io/api/0/projects/${SENTRY_ORG}/${SENTRY_PROJECT}/events/?query=${ENCODED_QUERY}"
          
          echo "Polling Sentry API..."
          echo "Max attempts: 12 (60 seconds total)"
          echo ""
          
          FOUND=0
          for i in {1..12}; do
            printf "Attempt %2d/12: " "$i"
            
            resp=$(curl -s -H "$AUTH" "$URL")
            count=$(echo "$resp" | python3 -c "import sys,json; data=sys.stdin.read(); arr=json.loads(data) if data.strip() else []; print(len(arr))") || count=0
            
            if [ "$count" -gt 0 ]; then
              echo "✓ Event found!"
              FOUND=1
              break
            else
              echo "⏳ Waiting..."
            fi
            
            sleep 5
          done
          
          echo ""
          echo "================================================"
          if [ "$FOUND" -eq 1 ]; then
            echo "✓ SUCCESS: Sentry ingestion verified"
            echo "================================================"
            exit 0
          else
            echo "✗ FAILURE: Event not found after 60 seconds"
            echo "================================================"
            exit 2
          fi

      - name: Verification summary
        if: always()
        run: |
          echo "================================================"
          echo "Sentry Staging Verification Complete"
          echo "================================================"
          if [ "${{ env.SENTRY_AUTH_TOKEN }}" = "" ]; then
            echo "⚠️  Sentry secrets not configured - verification skipped"
          else
            echo "Status: Check above for results"
          fi
          echo "================================================"
