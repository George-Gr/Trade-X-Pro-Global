name: Sentry Staging Verification

on:
  push:
    branches: [ staging ]
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize verification
        run: |
          echo "================================================"
          echo "Sentry Staging Verification Starting"
          echo "================================================"
          echo "Commit: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "================================================"

      - name: Check Sentry configuration
        id: check_sentry
        run: |
          if [ -n "${{ secrets.SENTRY_AUTH_TOKEN }}" ] && [ -n "${{ secrets.SENTRY_ORG }}" ] && [ -n "${{ secrets.SENTRY_PROJECT }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "‚úì Sentry secrets are configured"
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Sentry secrets not configured - skipping verification"
          fi

      - name: Install Sentry CLI
        if: steps.check_sentry.outputs.configured == 'true'
        run: |
          echo "üì• Installing Sentry CLI..."
          curl -sL https://sentry.io/get-cli/ | bash
          sentry-cli --version

      - name: Send test event to Sentry
        if: steps.check_sentry.outputs.configured == 'true'
        run: |
          echo "üì§ Sending test event to Sentry..."
          sentry-cli send-event -m "Staging smoke test: commit=${{ github.sha }} run=${{ github.run_id }}"
          echo "‚úì Test event sent successfully"

      - name: Verify event ingestion
        if: steps.check_sentry.outputs.configured == 'true'
        run: |
          set -euo pipefail
          
          echo "================================================"
          echo "Verifying Sentry Event Ingestion"
          echo "================================================"
          
          QUERY="Staging smoke test: commit=${{ github.sha }} run=${{ github.run_id }}"
          ENCODED_QUERY=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))" "$QUERY")
          AUTH="Authorization: Bearer ${SENTRY_AUTH_TOKEN}"
          URL="https://sentry.io/api/0/projects/${SENTRY_ORG}/${SENTRY_PROJECT}/events/?query=${ENCODED_QUERY}"
          
          echo "Polling Sentry API..."
          echo "Max attempts: 12 (60 seconds total)"
          echo ""
          
          FOUND=0
          for i in {1..12}; do
            printf "Attempt %2d/12: " "$i"
            
            resp=$(curl -s -H "$AUTH" "$URL")
            count=$(echo "$resp" | python3 -c "import sys,json; data=sys.stdin.read(); arr=json.loads(data) if data.strip() else []; print(len(arr))") || count=0
            
            if [ "$count" -gt 0 ]; then
              echo "‚úì Event found!"
              FOUND=1
              break
            else
              echo "‚è≥ Waiting..."
            fi
            
            sleep 5
          done
          
          echo ""
          echo "================================================"
          if [ "$FOUND" -eq 1 ]; then
            echo "‚úì SUCCESS: Sentry ingestion verified"
            echo "================================================"
            exit 0
          else
            echo "‚úó FAILURE: Event not found after 60 seconds"
            echo "================================================"
            exit 2
          fi

      - name: Verification summary
        if: always()
        run: |
          echo "================================================"
          echo "Sentry Staging Verification Complete"
          echo "================================================"
          if [ "${{ steps.check_sentry.outputs.configured }}" = "true" ]; then
            echo "‚úì Verification executed - check results above"
          else
            echo "‚ö†Ô∏è  Verification skipped - Sentry secrets not configured"
          fi
          echo "================================================"
